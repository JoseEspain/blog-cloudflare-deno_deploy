---
/**
 * @file src/layouts/Layout.astro
 * @description 网站的全局主布局文件。
 * 负责定义所有页面的通用HTML结构（<head>、导航、页脚），
 * 并通过 `layoutMode` prop 提供三种不同的宏观布局模式：
 * - `homepage`: 用于首页的特殊背景和边距布局。
 * - `document`: 用于标准文章页，提供 `prose` 排版样式。
 * - `app`:      用于全屏应用（如AI聊天），提供flex弹性布局。
 */
import Navbar from '../components/Navbar.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

// 定义组件可接受的属性
export interface Props {
  title?: string;
  description?: string;
  image?: string;
  layoutMode?: 'app' | 'document' | 'homepage';
}

// 获取当前语言和翻译函数
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// 解构属性并提供默认值
const { 
  title = t('site.title'), 
  description = t('site.description'), 
  image,
  layoutMode = 'homepage' // 默认使用首页布局
} = Astro.props;

// --- SEO 和 URL 相关变量 ---
const siteUrl = 'https://blog-fyx.pages.dev'; // <-- PLACEHOLDER
const canonicalUrl = new URL(Astro.url.pathname, siteUrl);
const ogImageUrl = new URL(image ?? '/images/common/main.jpg', siteUrl);
const isArticle = Astro.url.pathname.startsWith('/blog/');

// --- 根据布局模式动态生成CSS类 ---

// 为 body 标签生成类，app模式下需要撑满全屏
const bodyClass = [
  'dark:bg-gray-900',
  layoutMode === 'app' ? 'h-screen flex flex-col overflow-hidden' : ''
].join(' ');

// 为 main 标签（主内容区）生成类
const mainContentClass = layoutMode === 'app'
  ? 'flex-grow flex flex-col min-h-0 pt-16' // app模式：弹性增长，用于应用UI
  : layoutMode === 'document'
    ? 'prose dark:prose-invert max-w-4xl mx-auto p-4 pt-24' // document模式：文章排版
    : layoutMode === 'homepage'
    ? 'min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 pt-24' // homepage模式：首页特殊背景
    : ''; // 其他情况无特殊样式

// 为 footer 标签生成类
const footerClass = [
  'text-center p-4 text-gray-600 dark:text-gray-400',
  layoutMode === 'app' ? 'flex-shrink-0' : 'mt-8'
].join(' ');
---

<!doctype html>
<html lang={lang === 'zh' ? 'zh-CN' : 'en'}>
  <head>
    <meta charset="utf-8" />
    <meta name="baidu-site-verification" content="codeva-Kcd2m0tKdA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    {/* SEO 和社交媒体分享的 Meta 标签 */}
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:type" content={isArticle ? 'article' : 'website'} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalUrl} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={ogImageUrl} />
    
    {/* 外部CSS库：全局样式、数学公式、代码高亮 */}
    <link rel="stylesheet" href="/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
      integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github-dark.min.css"
      media="(prefers-color-scheme: dark)"
    />

    {/* 内联脚本，用于在页面渲染前设置深色模式，防止闪烁 */}
    <script is:inline set:html={`
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    `} />

  </head>
  <body class={bodyClass}>
    <Navbar />
    <main class={mainContentClass}>
      {/* 子页面内容将通过插槽注入到这里 */}
      <slot />
    </main>

    <footer class={footerClass}>
      <p>&copy; {new Date().getFullYear()} Fan YiXiong. {t('footer.copyright')}.</p>
    </footer>
  </body>
</html>